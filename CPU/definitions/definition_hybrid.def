Bootstrap: docker
From: ubuntu:20.04

%files
    ~/cloud_noise_repository/ /opt

%environment
    export OMPI_DIR=/opt/ompi
    export APPTAINER_OMPI_DIR=$OMPI_DIR
    export APPTAINERENV_APPEND_PATH=$OMPI_DIR/bin
    export APPTAINERENV_APPEND_LD_LIBRARY_PATH=$OMPI_DIR/lib
    export CFLAGS="-I/usr/include/x86_64-linux-gnu -pthread"  # May need adjustment
    export LDFLAGS="-lpthread"
    export DEBIAN_FRONTEND=noninteractive
%post
    echo "Installing required packages..."
    ln -sf /usr/share/zoneinfo/Europe/London /etc/localtime
    apt-get update && apt-get install -y libpthread-stubs0-dev wget git bash gcc gfortran gcc-12 g++-12 bzip2 make file xz-utils \
    build-essential \
        software-properties-common \
        gfortran \
        openmpi-bin openmpi-common libopenmpi-dev \
        libopenblas-dev \
        liblapack-dev \
        libhdf5-dev \
        libboost-all-dev \
        libmpich-dev \
        libnuma-dev \
        librdmacm-dev \
        libibverbs-dev \
        libatomic1 \
        sudo \
        python3 \
        python3-pip \
        libssl-dev \
        rsync \
        vim \
        tar \
        unzip

    echo "Installing Open MPI"
    export OMPI_DIR=/opt/ompi
    export OMPI_VERSION=4.1.5
    export OMPI_URL="https://download.open-mpi.org/release/open-mpi/v4.1/openmpi-$OMPI_VERSION.tar.bz2"
    mkdir -p /tmp/ompi
    mkdir -p /opt
    # Download
    cd /tmp/ompi && wget -O openmpi-$OMPI_VERSION.tar $OMPI_URL && tar -xjf openmpi-$OMPI_VERSION.tar
    # Compile and install
    cd /tmp/ompi/openmpi-$OMPI_VERSION && ./configure --prefix=$OMPI_DIR && make install
    # Set env variables so we can compile our application
    export PATH=$OMPI_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH
    export MANPATH=$OMPI_DIR/share/man:$MANPATH

    echo "Compiling the application..."
    cd /opt/cloud_noise/benchmarks && ./compile.sh
    echo "Compiling the MPI TEST..."
    cd /opt/cloud_noise/benchmarks && mpicc helloworld.c -o hello
	


        
